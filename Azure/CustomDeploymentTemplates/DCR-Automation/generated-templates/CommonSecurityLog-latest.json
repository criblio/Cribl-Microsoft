{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "dataCollectionRuleName": {
      "type": "string",
      "metadata": {
        "description": "Specifies the name of the Data Collection Rule to create."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Specifies the location in which to create the Data Collection Rule."
      }
    },
    "workspaceResourceId": {
      "type": "string",
      "metadata": {
        "description": "Specifies the Azure resource ID of the Log Analytics workspace to use."
      }
    },
    "endpointResourceId": {
      "type": "string",
      "metadata": {
        "description": "Specifies the Azure resource ID of the Data Collection Endpoint to use."
      }
    }
  },
  "variables": {
    "streamName": "Custom-CommonSecurityLog",
    "_comment": "These values are hardcoded in the template",
    "outputStreamName": "Microsoft-CommonSecurityLog"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2023-03-11",
      "name": "[parameters('dataCollectionRuleName')]",
      "location": "[parameters('location')]",
      "properties": {
        "dataCollectionEndpointId": "[parameters('endpointResourceId')]",
        "streamDeclarations": {
          "Custom-CommonSecurityLog": {
            "columns": [
              {
                "type": "datetime",
                "name": "TimeGenerated"
              },
              {
                "type": "string",
                "name": "DeviceVendor"
              },
              {
                "type": "string",
                "name": "DeviceProduct"
              },
              {
                "type": "string",
                "name": "DeviceVersion"
              },
              {
                "type": "string",
                "name": "DeviceEventClassID"
              },
              {
                "type": "string",
                "name": "Activity"
              },
              {
                "type": "string",
                "name": "LogSeverity"
              },
              {
                "type": "string",
                "name": "OriginalLogSeverity"
              },
              {
                "type": "string",
                "name": "AdditionalExtensions"
              },
              {
                "type": "string",
                "name": "DeviceAction"
              },
              {
                "type": "string",
                "name": "ApplicationProtocol"
              },
              {
                "type": "int",
                "name": "EventCount"
              },
              {
                "type": "string",
                "name": "DestinationDnsDomain"
              },
              {
                "type": "string",
                "name": "DestinationServiceName"
              },
              {
                "type": "string",
                "name": "DestinationTranslatedAddress"
              },
              {
                "type": "int",
                "name": "DestinationTranslatedPort"
              },
              {
                "type": "string",
                "name": "CommunicationDirection"
              },
              {
                "type": "string",
                "name": "DeviceDnsDomain"
              },
              {
                "type": "string",
                "name": "DeviceExternalID"
              },
              {
                "type": "string",
                "name": "DeviceFacility"
              },
              {
                "type": "string",
                "name": "DeviceInboundInterface"
              },
              {
                "type": "string",
                "name": "DeviceNtDomain"
              },
              {
                "type": "string",
                "name": "DeviceOutboundInterface"
              },
              {
                "type": "string",
                "name": "DevicePayloadId"
              },
              {
                "type": "string",
                "name": "ProcessName"
              },
              {
                "type": "string",
                "name": "DeviceTranslatedAddress"
              },
              {
                "type": "string",
                "name": "DestinationHostName"
              },
              {
                "type": "string",
                "name": "DestinationMACAddress"
              },
              {
                "type": "string",
                "name": "DestinationNTDomain"
              },
              {
                "type": "int",
                "name": "DestinationProcessId"
              },
              {
                "type": "string",
                "name": "DestinationUserPrivileges"
              },
              {
                "type": "string",
                "name": "DestinationProcessName"
              },
              {
                "type": "int",
                "name": "DestinationPort"
              },
              {
                "type": "string",
                "name": "DestinationIP"
              },
              {
                "type": "string",
                "name": "DeviceTimeZone"
              },
              {
                "type": "string",
                "name": "DestinationUserID"
              },
              {
                "type": "string",
                "name": "DestinationUserName"
              },
              {
                "type": "string",
                "name": "DeviceAddress"
              },
              {
                "type": "string",
                "name": "DeviceName"
              },
              {
                "type": "string",
                "name": "DeviceMacAddress"
              },
              {
                "type": "int",
                "name": "ProcessID"
              },
              {
                "type": "datetime",
                "name": "EndTime"
              },
              {
                "type": "int",
                "name": "ExternalID"
              },
              {
                "type": "string",
                "name": "ExtID"
              },
              {
                "type": "string",
                "name": "FileCreateTime"
              },
              {
                "type": "string",
                "name": "FileHash"
              },
              {
                "type": "string",
                "name": "FileID"
              },
              {
                "type": "string",
                "name": "FileModificationTime"
              },
              {
                "type": "string",
                "name": "FilePath"
              },
              {
                "type": "string",
                "name": "FilePermission"
              },
              {
                "type": "string",
                "name": "FileType"
              },
              {
                "type": "string",
                "name": "FileName"
              },
              {
                "type": "int",
                "name": "FileSize"
              },
              {
                "type": "long",
                "name": "ReceivedBytes"
              },
              {
                "type": "string",
                "name": "Message"
              },
              {
                "type": "string",
                "name": "OldFileCreateTime"
              },
              {
                "type": "string",
                "name": "OldFileHash"
              },
              {
                "type": "string",
                "name": "OldFileID"
              },
              {
                "type": "string",
                "name": "OldFileModificationTime"
              },
              {
                "type": "string",
                "name": "OldFileName"
              },
              {
                "type": "string",
                "name": "OldFilePath"
              },
              {
                "type": "string",
                "name": "OldFilePermission"
              },
              {
                "type": "int",
                "name": "OldFileSize"
              },
              {
                "type": "string",
                "name": "OldFileType"
              },
              {
                "type": "long",
                "name": "SentBytes"
              },
              {
                "type": "string",
                "name": "EventOutcome"
              },
              {
                "type": "string",
                "name": "Protocol"
              },
              {
                "type": "string",
                "name": "Reason"
              },
              {
                "type": "string",
                "name": "RequestURL"
              },
              {
                "type": "string",
                "name": "RequestClientApplication"
              },
              {
                "type": "string",
                "name": "RequestContext"
              },
              {
                "type": "string",
                "name": "RequestCookies"
              },
              {
                "type": "string",
                "name": "RequestMethod"
              },
              {
                "type": "string",
                "name": "ReceiptTime"
              },
              {
                "type": "string",
                "name": "SourceHostName"
              },
              {
                "type": "string",
                "name": "SourceMACAddress"
              },
              {
                "type": "string",
                "name": "SourceNTDomain"
              },
              {
                "type": "string",
                "name": "SourceDnsDomain"
              },
              {
                "type": "string",
                "name": "SourceServiceName"
              },
              {
                "type": "string",
                "name": "SourceTranslatedAddress"
              },
              {
                "type": "int",
                "name": "SourceTranslatedPort"
              },
              {
                "type": "int",
                "name": "SourceProcessId"
              },
              {
                "type": "string",
                "name": "SourceUserPrivileges"
              },
              {
                "type": "string",
                "name": "SourceProcessName"
              },
              {
                "type": "int",
                "name": "SourcePort"
              },
              {
                "type": "string",
                "name": "SourceIP"
              },
              {
                "type": "datetime",
                "name": "StartTime"
              },
              {
                "type": "string",
                "name": "SourceUserID"
              },
              {
                "type": "string",
                "name": "SourceUserName"
              },
              {
                "type": "int",
                "name": "EventType"
              },
              {
                "type": "string",
                "name": "DeviceEventCategory"
              },
              {
                "type": "string",
                "name": "DeviceCustomIPv6Address1"
              },
              {
                "type": "string",
                "name": "DeviceCustomIPv6Address1Label"
              },
              {
                "type": "string",
                "name": "DeviceCustomIPv6Address2"
              },
              {
                "type": "string",
                "name": "DeviceCustomIPv6Address2Label"
              },
              {
                "type": "string",
                "name": "DeviceCustomIPv6Address3"
              },
              {
                "type": "string",
                "name": "DeviceCustomIPv6Address3Label"
              },
              {
                "type": "string",
                "name": "DeviceCustomIPv6Address4"
              },
              {
                "type": "string",
                "name": "DeviceCustomIPv6Address4Label"
              },
              {
                "type": "real",
                "name": "DeviceCustomFloatingPoint1"
              },
              {
                "type": "string",
                "name": "DeviceCustomFloatingPoint1Label"
              },
              {
                "type": "real",
                "name": "DeviceCustomFloatingPoint2"
              },
              {
                "type": "string",
                "name": "DeviceCustomFloatingPoint2Label"
              },
              {
                "type": "real",
                "name": "DeviceCustomFloatingPoint3"
              },
              {
                "type": "string",
                "name": "DeviceCustomFloatingPoint3Label"
              },
              {
                "type": "real",
                "name": "DeviceCustomFloatingPoint4"
              },
              {
                "type": "string",
                "name": "DeviceCustomFloatingPoint4Label"
              },
              {
                "type": "int",
                "name": "DeviceCustomNumber1"
              },
              {
                "type": "long",
                "name": "FieldDeviceCustomNumber1"
              },
              {
                "type": "string",
                "name": "DeviceCustomNumber1Label"
              },
              {
                "type": "int",
                "name": "DeviceCustomNumber2"
              },
              {
                "type": "long",
                "name": "FieldDeviceCustomNumber2"
              },
              {
                "type": "string",
                "name": "DeviceCustomNumber2Label"
              },
              {
                "type": "int",
                "name": "DeviceCustomNumber3"
              },
              {
                "type": "long",
                "name": "FieldDeviceCustomNumber3"
              },
              {
                "type": "string",
                "name": "DeviceCustomNumber3Label"
              },
              {
                "type": "string",
                "name": "DeviceCustomString1"
              },
              {
                "type": "string",
                "name": "DeviceCustomString1Label"
              },
              {
                "type": "string",
                "name": "DeviceCustomString2"
              },
              {
                "type": "string",
                "name": "DeviceCustomString2Label"
              },
              {
                "type": "string",
                "name": "DeviceCustomString3"
              },
              {
                "type": "string",
                "name": "DeviceCustomString3Label"
              },
              {
                "type": "string",
                "name": "DeviceCustomString4"
              },
              {
                "type": "string",
                "name": "DeviceCustomString4Label"
              },
              {
                "type": "string",
                "name": "DeviceCustomString5"
              },
              {
                "type": "string",
                "name": "DeviceCustomString5Label"
              },
              {
                "type": "string",
                "name": "DeviceCustomString6"
              },
              {
                "type": "string",
                "name": "DeviceCustomString6Label"
              },
              {
                "type": "string",
                "name": "DeviceCustomDate1"
              },
              {
                "type": "string",
                "name": "DeviceCustomDate1Label"
              },
              {
                "type": "string",
                "name": "DeviceCustomDate2"
              },
              {
                "type": "string",
                "name": "DeviceCustomDate2Label"
              },
              {
                "type": "string",
                "name": "FlexDate1"
              },
              {
                "type": "string",
                "name": "FlexDate1Label"
              },
              {
                "type": "int",
                "name": "FlexNumber1"
              },
              {
                "type": "string",
                "name": "FlexNumber1Label"
              },
              {
                "type": "int",
                "name": "FlexNumber2"
              },
              {
                "type": "string",
                "name": "FlexNumber2Label"
              },
              {
                "type": "string",
                "name": "FlexString1"
              },
              {
                "type": "string",
                "name": "FlexString1Label"
              },
              {
                "type": "string",
                "name": "FlexString2"
              },
              {
                "type": "string",
                "name": "FlexString2Label"
              },
              {
                "type": "string",
                "name": "RemoteIP"
              },
              {
                "type": "string",
                "name": "RemotePort"
              },
              {
                "type": "string",
                "name": "MaliciousIP"
              },
              {
                "type": "int",
                "name": "ThreatSeverity"
              },
              {
                "type": "string",
                "name": "IndicatorThreatType"
              },
              {
                "type": "string",
                "name": "ThreatDescription"
              },
              {
                "type": "string",
                "name": "ThreatConfidence"
              },
              {
                "type": "string",
                "name": "ReportReferenceLink"
              },
              {
                "type": "real",
                "name": "MaliciousIPLongitude"
              },
              {
                "type": "real",
                "name": "MaliciousIPLatitude"
              },
              {
                "type": "string",
                "name": "MaliciousIPCountry"
              },
              {
                "type": "string",
                "name": "Computer"
              },
              {
                "type": "string",
                "name": "SimplifiedDeviceAction"
              },
              {
                "type": "string",
                "name": "CollectorHostName"
              }
            ]
          }
        },
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[parameters('workspaceResourceId')]",
              "name": "logAnalyticsWorkspace"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Custom-CommonSecurityLog"
            ],
            "destinations": [
              "logAnalyticsWorkspace"
            ],
            "transformKql": "source",
            "outputStream": "Microsoft-CommonSecurityLog"
          }
        ]
      }
    }
  ],
  "outputs": {
    "dataCollectionRuleId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Insights/dataCollectionRules', parameters('dataCollectionRuleName'))]"
    }
  },
  "metadata": {
    "streamName": "Custom-CommonSecurityLog",
    "tableName": "CommonSecurityLog",
    "outputStreamName": "Microsoft-CommonSecurityLog",
    "deploymentMode": "DCE-based",
    "generatedOn": "2025-09-10 16:28:26",
    "tableType": "Native"
  }
}
